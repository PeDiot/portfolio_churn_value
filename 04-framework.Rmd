---
output: html_document2
editor_options: 
  chunk_output_type: console
---

```{r echo=FALSE}
knitr::opts_chunk$set(
  fig.align = "center", 
  echo = FALSE, 
  message = FALSE, 
  comment = FALSE, 
  warning = FALSE
)
```

```{r packages}
library(ggplot2)
library(tidyverse)
library(latex2exp)
```

```{r plot_config}
theme_set(theme_minimal())
plot_col <- "#4DB9A5"
```


# Theoretical Framework {#framework}

This chapter presents theoretical basis of the models and the algorithms that are used to model customer portfolios. As a customer's lifetime in a portfolio is usually represented by the time to churn, duration models are adapted to the data we have at our disposal. Thus, it is decided to introduce standard survival techniques as well as machine learning algorithms suited to time-to-event data. Methods to estimate customer's value are also introduced in this chapter. 

## Duration models

According to Cameron & Trivedi [@CAMERON_TRIVEDI], duration models (also called survival models) aims at measuring the time spent in a certain state before transitioning to another state. In Econometrics, 

- a **state** corresponds to the class in which an individual $i$ is at time $t$. 
- a **transition** is movement from one state to another. 
- a **duration** measures the time spent in a certain state and is also called a **spell** length. 

Since measuring the time until the event is needed for multiple purposes, duration analysis is used in a variety of economic sectors as depicted by the following table. 

| Economic sector    | Purpose                                       | 
| :---------------:  |:--------------------------------------------: | 
| Macroeconomics     | Length of an unemployment spell               | 
| Insurance          | Risk analysis to offer a segmented pricing    | 
| Engineering        | Time until a device breaks down               |
| Epidemiology       | Survival time of a virus                      | 
| **Churn analysis** | **Time until a customer leave the portfolio** |


### Censoring and Truncation

When dealing with survival data, some observations are usually **censored** meaning they are related to spells which are not completely observed. Duration data can also suffer from a selection bias which is called **truncation**. 

#### Censoring mechanisms {-}

**Left-censoring** occurs when the event of interest occurs before the beginning of the observation period. For example, an individual is included in a study of duration of unemployment at $t_0$. At that time he has already been unemployed for a period but he cannot recall exactly the duration of this period. If we observe that he finds a job again at $t_1$, we can only deduce that the duration of unemployment is bigger than $t_1-t_0$, this individual is left-censored. Observation 2 on figure \@ref(fig:censoring) is associated with a left-censored spell [@LIU_SCOR].  

A spell is considered **right-censored** when it is observed from time $t_0$ until a censoring time $t_c$ as illustrated by observation 1 on figure \@ref(fig:censoring). For instance, the lifetime related to a customer who has not churned at the end of the observation period is right-censored. Let us note $X_i$ the duration of a complete spell and $C_i$ the duration of a right-censored spell. We also note $T_i$ the duration actually observed and $\delta_i$ the censoring indicator such that $\delta_i = 0$ if the spell is censored. Then, $(t_1, \delta_1),\dots,(t_N, \delta_N)$ are the realizations of the following random variables: 

\begin{equation}
  \begin{aligned}
  T_i & = \min(X_i, C_i) \\
  \delta_i & = \mathbb{1}_{X_i < C_i}
  \end{aligned}
  (\#eq:censoring)
\end{equation}

#### Selection bias {-} 

Survival data suffers from a **selection bias** (or truncation) when only a sub-sample of the population of interest is studied. A customer entering the firm's portfolio after the end of the study is said to be **right-truncated**, whereas a client who has left the portfolio before the beginning of the study is considered **left-truncated**. Mathematically, a random variable $X$ is truncated by a subset $A \in \mathbb{R}^+$ if instead of $\Omega(X)$, we solely observe $\Omega(X)\bigcap A$. On figure \@ref(fig:censoring), the first and fifth observations suffers from a selection bias. 

```{r censoring, echo=FALSE, fig.cap="Censored and truncated data", out.height="250px", out.width="500px"}
knitr::include_graphics(path = "./imgs/censoring_and_truncation.png")
```

### Probabilistic concepts 

In survival analysis, the response variable denoted $T$ is a time-to-event variable. Instead of estimating the expected failure time, survival models estimate the *survival* and *hazard rate* functions which depend on the realization of $T$. 


#### Survival function {-}

The survival function $S(t)$ represents the probability that the considered event occurs after time $t$. For instance, $S(t)$ can measure the probability that a given customer survive in the portfolio at least until time $t$. Mathematically, the survival function is defined as: 
\begin{equation}
  S(t) = P(T > t) = 1 - F(t)
  (\#eq:survfun)
\end{equation}

where $F(t)$ is the cumulative distribution function. 

```{r survfunexp}
x <- seq(0, 10, .01)
theta <- 1
surv_exp <- 1 - pexp(q = x, rate = theta)
surv_fun_plot <- data.frame(x, surv_exp) %>%
  ggplot(aes(x = x, y = surv_exp)) +
  geom_line(size = 1, color = plot_col) +
  xlab(TeX("$t$")) + ylab(TeX("$S(t)$")) +
  theme(axis.title = element_text(size = 12), 
        axis.text = element_text(size = 11))
ggsave(filename = "./imgs/surv_fun_plot.png", 
       plot = surv_fun_plot) 

```

```{r survfunplot, echo=FALSE, fig.cap="Survival function $S_T(t)$ with $T \\sim \\mathcal{E} (1)$", out.height="300px", out.width="400px"}
knitr::include_graphics(path = "./imgs/surv_fun_plot.png")
```


#### Hazard and Cumulative Hazard functions {-}

Another key concept in duration analysis is the hazard function $\lambda(t)$ which approximates the probability that the event occurs at time $t$. For instance, $\lambda(t)$ can measure the probability that a given individual leaves the firm portfolio at time $t$. Formally, it is expressed as follows: 
\begin{equation}
  \lambda(t) = \lim_{\Delta t \to 0} \frac{P\big[t \leq T < t + \Delta t | T \geq t \big]}{\Delta t}
  (\#eq:hazfun)
\end{equation}

Using the Bayes formula, equation \@ref(eq:hazfun) can also be written as (see equation \@ref(eq:hazfunproof) in appendix):
\begin{equation}
  \lambda(t) = \frac{-\text{d} \ln \big(S(t)\big)}{\text{d} t}
  (\#eq:hazfunbis)
\end{equation}

Finally, integrating the instantaneous hazard function gives the cumulative hazard function which can be more precisely estimated than the hazard function [@CAMERON_TRIVEDI] and is defined as: 

\begin{equation}
  \Lambda (t) = \int_{0}^{t} \lambda(s) \text{d}s = \ln \big(S(t)\big)
  (\#eq:cumhazfun)
\end{equation}

```{r}
cum_haz <- x 
cum_haz_plot <- data.frame(x, cum_haz) %>%
  ggplot(aes(x = x, y = cum_haz)) +
  geom_line(size = 1, color = plot_col) +
  xlab(TeX("$t$")) + ylab(TeX("$\\Lambda(t)$")) +
  theme(axis.title = element_text(size = 12), 
        axis.text = element_text(size = 11))
ggsave(filename = "./imgs/cum_haz_plot.png", 
       plot = cum_haz_plot) 
```

```{r cumhazplot, echo=FALSE, fig.cap="Cumulative Hazard function $\\Lambda_T(t)$ with $T \\sim \\mathcal{E} (1)$", out.height="300px", out.width="400px"}
knitr::include_graphics(path = "./imgs/cum_haz_plot.png")
```

Thus, the hazard, survival and cumulative hazard functions are three mathematical functions which describe the same distribution. 

### Nonparametric models 

When dealing with duration data, these methods are helpful to have a general overview of the raw (unconditional) hazard. Nonparametric models are rather used for data description rather than prediction. No explanatory variable is included in these models except for treatment variables such as the type of contract a customer has subscribe.  

#### Notations {-}

Let us consider a sample with $N$ observations with $k$ discrete failure time (e.g. a failure can be a churn event), such that $\forall j \in [\![1; k]\!]$ : 

- $t_j$ the $j^{\text{th}}$ discrete failure time, 
- $d_j$ the number of spells terminating at $t_j$,
- $m_j$ the number of right-censored spells in the interval $[t_j, t_{j+1}]$,
- $r_j$ the number of exposed durations right before time $t_j$ such that: 
\begin{equation}
  r_j = (d_j + m_j) + \dots + (d_k + m_k) = \sum_{l|l \geq j} (d_l + m_l)
  (\#eq:exposed)
\end{equation}

#### Hazard function estimator {-}

As the instantaneous hazard at time $t_j$ is defined as $\lambda_j = P[T=t_j|T\geq t_j]$, a trivial estimator of $\lambda_j$ is obtained by dividing the number of durations for which the event is realized in $t_j$ by the total number of exposed durations at time $t_j^{-}$. Formally, it is expressed as: 

\begin{equation}
  \hat{\lambda}_j = \frac{d_j}{r_j}
  (\#eq:hazest)
\end{equation}

#### Kaplan-Meier estimator {-}

Once the hazard function estimator computed, the discrete-time survivor function can be estimated using the Kaplan-Meier estimator. To estimate the survival at time $t$, this estimator computes the joint probability that a spell stays in the same state until $t$ (e.g. remaining loyal to a firm until a certain time). Mathematically, we have:

\begin{equation}
  \hat{S}(t) = \Pi_{j|t_j \leq t} \big(1-\hat{\lambda}_j\big) = \Pi_{j|t_j \leq t}\frac{r_j - d_j}{r_j}
  (\#eq:kaplanmeier)
\end{equation}

When plotting the survival curve after having performed the Kaplan-Meier estimation, confidence bands are also added to the plot in order to reflect sampling variability [@CAMERON_TRIVEDI]. The confidence interval of the survival function $S(t)$ is derived from the estimate of the variance of $S(t)$ which is obtained by the Grenwood estimate (see equation \@ref(eq:greenwood)).

\begin{equation}
  \hat{\mathrm{V}}[\hat{S}(t)] = \hat{S}(t)^2 \sum_{j|t_j \leq t} \frac{d_j}{r_j(r_j-d_j)}
  (\#eq:greenwood)
\end{equation}

#### Nelson-Aalen estimator {-}

The cumulative hazard function estimate is given by the Nelson-Aalen estimator which consists in summing up the hazard estimates for each failure time. 

\begin{equation}
  \hat{\Lambda}(t) = \sum_{j | t_j \leq t} \hat{\lambda}_{j} = \sum_{j | t_j \leq t} \frac{d_j}{r_j}
  (\#eq:nelsonaalen)
\end{equation}

Exponentiating $\hat{\Lambda}(t)$, one can obtain a second estimate of the survival function (see equation \@ref(eq:linksurvcumhaz) in the appendix): 

\begin{equation}
    \tilde{S}(t) = \exp \big( -\hat{\Lambda}(t) \big)
    (\#eq:survest)
\end{equation}


## Machine Learning techniques {#ML}

