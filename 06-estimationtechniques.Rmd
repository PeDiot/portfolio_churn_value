---
output: html_document2
editor_options: 
  chunk_output_type: console
---

```{r echo=FALSE}
knitr::opts_chunk$set(
  fig.align = "center", 
  echo = FALSE, 
  message = FALSE, 
  comment = FALSE, 
  warning = FALSE, 
  fig.topcaption = TRUE
)
```

```{r}
source("functions.R", 
       encoding = "UTF-8")
```

```{r}
data_path <- "./data/"
```


```{r}
library(tidyverse)    # data wrangling
library(ggplot2)      # fancy plots 
library(ggsci)        # fancy palettes
library(ggpubr)       # arrange plots

library(knitr)        # kable
library(kableExtra)   # fancy tables

library(survival)     # Kaplan-Meier
library(survminer)    # display survival plots 
```

```{r}
theme_set(theme_minimal())
```


# Estimation techniques 

This chapter explains the different methods used to model a portfolio of customers as well as their related risk of attrition and the overall value of the portfolio. In a first part, clustering techniques are implemented to identify segments of customers based on services and account variables. Then, survival models are fitted to estimate each customer's survival in the firm's portfolio. The selected model can also be used to assess the effects of each variable on the risk of churn. Finally, we answer the study's problematic by computing an estimated value of the portfolio. The latter is calculated using a corporate formula and takes customers' monthly fees and survival probabilities as inputs. The estimated portfolio value is not cost-adjusted there is no information on consumers' costs in the data set.

## Feature selection 

Before fitting any survival model or clustering algorithm to the data, the initial step consists in selecting variables that are discriminating in terms of churn hazard. Based on Kaplan-Meier analysis depicted in section \@ref(churndescstats), we have a general overview of features which influence the survival probability. In other words, our feature selection method relies on results obtained with descriptive statistics. 

Table \@ref(tab:selectedfeatures) shows the selected variables for 5 random observations extracted from the data set. It can be noted that these features are related to account or service information, apart from `Dependents` which indicates whether the client lives with any dependents (children, parents, etc). Furthermore, 9 out of the 10 selected variables are categorical which implies that the estimation results could be used to compare different groups of client. `Monthly_Charges` is the only quantitative variable used to fit clustering models and survival regressions. 

```{r selectedfeatures}
load(file = paste0(data_path, "telco_cleaned.RData"))
cleaned_data %>%
  select(c(
    "Dependents", 
    "Phone_Service", 
    "Internet_Service", 
    "Online_Security", 
    "Online_Security", 
    "Online_Backup", 
    "Tech_Support", 
    "Contract", 
    "Payment_Method", 
    "Monthly_Charges"
  )) %>%
  sample_n(5) %>%
  mykable(title = "Explanatory variables used in survival models") %>%
  scroll_box(width = "100%", box_css = "border: 0px;")
```

Eventually, it seems important to recall that `Tenure_Months` and `Churn_Value` can be seen as a pair of time and event variables which is the target in survival models. 

```{r target}
cleaned_data %>%
  select(c(
    "CustomerID", 
    "Tenure_Months",
    "Churn_Value"
  )) %>%
  sample_n(5) %>%
  mykable(title = "Time and event variables for survival models") 
```


## Portfolio segmentation 


### Transforming qualitative variables into principal axes


### Hierarchical clustering on principal components (HCPC)


## Churn analysis 

Estimating the risk of attrition related to each customer is an essential step to model the firm's portfolio. In this context, survival models can be implemented with a view of deriving a predicted churn risk and survival function for each client. One the one hand, these predictions can be used to identify loyal consumers and make appropriate decisions. For instance, it might be relevant to offer benefits to a high-value client with a high estimated churn risk. On the other hand, a customer's survival probability at time $t$ represents the chance that this very customer be active in the portfolio at time $t$. This measure will be helpful in the following section to compute the estimated value of the portfolio. 






### The Cox model 


### Other models 


### Model comparison


## Estimation of portfolio value 
